<!doctype html>
<html>

<head>
    <base href="https://polygit.org/components/">
    <script src="webcomponentsjs/webcomponents.js"></script>
</head>

<body>
    <div id="shadow-host">
    </div>
    <script>
        var shadowHost = document.querySelector('#shadow-host');
        shadowHost.observer = new MutationObserver(function(mutations) {
            shadowHost.observer.disconnect();
            // update
            // add EMPTY document fragment
            // removing those two lines solves/hides the problem
            var emptyDocFragment = document.createDocumentFragment();
            shadowHost.shadowRoot.appendChild(emptyDocFragment);
            // observe again
            shadowHost.observer.observe(shadowHost, {childList: true});

        });
        shadowHost.observer.observe(shadowHost, {childList: true});

        window.addEventListener('WebComponentsReady', function(e) {

            // stamp Shadow DOM
            var shadowRoot = shadowHost.createShadowRoot();
            // shadowRoot = this.attachShadow({mode: "open"});
            shadowRoot.innerHTML = '<div style="background: green;"><content></content></div>';


            // disabling this event fixes issue
            shadowHost.dispatchEvent(new CustomEvent("stamping"));

            // append Light DOM with just a tempalte tag
            shadowHost.appendChild(document.createTextNode('Am I ...'));

            setTimeout(function(){
                // append Light DOM with real elements
                shadowHost.appendChild(document.createTextNode(' green?'));
            });


        });
    </script>
</body>

</html>
